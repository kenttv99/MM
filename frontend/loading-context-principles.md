# Базовые принципы и компоненты контекста загрузки

## Архитектура системы загрузки

Система загрузки в приложении построена на основе нескольких ключевых контекстов, которые взаимодействуют между собой для обеспечения плавного пользовательского опыта:

### 1. LoadingContext

**Основная ответственность**: Управление стадиями загрузки и состоянием загрузки в приложении.

**Ключевые компоненты**:
- `LoadingStage` - перечисление стадий загрузки (AUTHENTICATION, STATIC_CONTENT, DYNAMIC_CONTENT, DATA_LOADING, COMPLETED)
- `setStage` - функция для явного перехода между стадиями с защитой от регрессии
- `setStaticLoading` - функция для управления статической загрузкой
- `setDynamicLoading` - функция для управления динамической загрузкой
- `resetLoading` - функция для сброса состояния загрузки с дебаунсингом
- `logDebug`, `logInfo`, `logWarn`, `logError` - функции для логирования с разными уровнями приоритета
- `detectAndFixLoadingInconsistency` - функция для обнаружения и исправления несогласованности флагов загрузки
- `safeSetState` - улучшенная функция безопасного обновления состояния с проверкой несогласованности
- `stageChangeHistoryRef` - отслеживание истории изменений стадий для предотвращения циклов и регрессии

**Принципы работы**:
- Стадии загрузки проходят последовательно
- Автоматический переход к следующей стадии после таймаута (5 секунд)
- Защита от частых сбросов состояния (дебаунс 2 секунды)
- Отслеживание истории изменений стадий для предотвращения циклов и регрессии
- Строгое блокирование возврата к стадии AUTHENTICATION после перехода к другим стадиям
- Периодическая проверка и исправление несогласованности между флагами загрузки и стадиями (каждые 2 секунды)
- Автоматический сброс флагов загрузки при завершении всех запросов
- Специальная обработка админских маршрутов с ускоренным переходом к COMPLETED
- Специальная обработка страницы мероприятий с защитой от зависания

**Система обнаружения несогласованности**:
- Периодическая проверка каждые 2 секунды на несоответствие между флагами и стадиями
- Автоматическое продвижение по стадиям при отсутствии активных запросов
- Принудительный сброс флагов загрузки при обнаружении аномалий
- Подробное логирование для диагностики и отслеживания исправлений
- Обнаружение "осиротевших" флагов загрузки при отсутствии индикатора в DOM
- Таймеры для гарантированного сброса флагов динамической загрузки при завершении запросов

### 2. AuthContext

**Основная ответственность**: Управление состоянием аутентификации пользователя.

**Ключевые компоненты**:
- `isAuthChecked` - флаг, указывающий, что проверка аутентификации завершена
- `isAuthenticated` - флаг, указывающий, что пользователь аутентифицирован
- `login`, `logout` - функции для управления аутентификацией
- `validateToken` - функция для проверки токена
- `handleUnauthorized` - обработчик событий авторизации

**Принципы работы**:
- Единственный источник истины для состояния аутентификации
- Автоматическая проверка токена при инициализации
- Самостоятельное уведомление LoadingContext о завершении проверки аутентификации через события
- Инициирование перехода к стадии STATIC_CONTENT после проверки, независимо от результата
- Защита от циклических проверок аутентификации

### 3. AdminAuthContext

**Основная ответственность**: Управление состоянием аутентификации администратора.

**Ключевые компоненты**:
- `isAuthChecked` - флаг, указывающий, что проверка аутентификации администратора завершена
- `isAuthenticated` - флаг, указывающий, что администратор аутентифицирован
- `login`, `logout` - функции для управления аутентификацией администратора
- `validateTokenLocally` - функция для локальной проверки токена без сетевых запросов
- `checkAuth` - функция для комплексной проверки авторизации
- `adminData` - профиль текущего администратора

**Принципы работы**:
- Аналогичен AuthContext, но для административной части
- Независимая проверка аутентификации от обычного AuthContext
- Самостоятельное управление переходами стадий загрузки
- Умная проверка авторизации для минимизации запросов к серверу:
  - Локальная валидация JWT-токена без сетевых запросов
  - Проверка срока истечения токена с буфером (TOKEN_EXPIRY_BUFFER = 300 секунд)
  - Дебаунсинг запросов проверки (SESSION_CHECK_DEBOUNCE_MS = 120000 мс)
  - Отправка запросов только при приближении к истечению срока действия
- Отметка админских маршрутов специальным флагом в localStorage (is_admin_route)
- Ускоренный переход через стадии загрузки для админских страниц

**Стратегия обновления токенов**:
- Автоматическое обновление через middleware на сервере:
  - Проверка всех запросов с заголовком Authorization
  - Обновление токена, если до истечения < 5 минут
  - Передача нового токена через заголовок X-Refresh-Token
- Обработка обновленных токенов на клиенте:
  - Проверка заголовка X-Refresh-Token в ответе
  - Сохранение обновленного токена в localStorage
  - Бесшовное продолжение сессии администратора

**Обработка ошибок авторизации**:
- Локальное удаление токена при истечении срока действия
- Использование локальной валидации при недоступности сервера
- Автоматическое перенаправление при отказе в доступе (403)
- Логирование всех попыток авторизации и ошибок доступа

### 4. API и запросы

**Основная ответственность**: Выполнение запросов к API с учетом текущей стадии загрузки.

**Ключевые компоненты**:
- `apiFetch` - функция для выполнения запросов с кэшированием и обработкой ошибок
- `shouldProcessRequest` - функция для проверки, должен ли запрос быть обработан на текущей стадии
- `setCurrentLoadingStage` - функция для обновления текущей стадии загрузки в API
- `bypassLoadingStageCheck` - опция для обхода проверки стадии загрузки для критических запросов
- `clearCache` - функция для очистки кэша по паттерну URL
- Очередь запросов и механизм дедупликации с интервалом 50мс
- Система обнаружения циклов изменения стадий
- Функции логирования с разными уровнями приоритета

**Конфигурация и ограничения**:
- Максимум 15 одновременных запросов (увеличено с 12)
- Интервал дедупликации запросов: 50мс (уменьшено со 100мс)
- Время жизни кэша: 60 секунд с расширением для ранних стадий загрузки
- Таймаут запроса: 15 секунд
- Задержка сброса глобальной блокировки: 50мс (уменьшено со 100мс)
- Таймаут ожидания в очереди: 10 секунд
- Отслеживание статистики запросов по стадиям загрузки

**Принципы работы**:
- Блокировка некритических запросов на ранних стадиях загрузки
- Разрешение аутентификационных запросов на стадии AUTHENTICATION
- Разрешение публичных запросов к мероприятиям на всех стадиях
- Разрешение статических и публичных запросов на стадии STATIC_CONTENT
- Разрешение всех запросов на стадиях DYNAMIC_CONTENT и выше
- Строгое предотвращение возврата к стадии AUTHENTICATION после перехода к более поздним стадиям
- Возможность обхода проверки стадии загрузки для критически важных запросов
- Углубленная работа с кэшем с расширенным TTL на ранних стадиях
- Автоматическое отклонение запросов с ошибкой 401 с отправкой события auth-unauthorized
- Оптимизированная обработка JSON и не-JSON ответов с попыткой распознавания

### 5. Компоненты интерфейса

**Основная ответственность**: Отображение интерфейса и взаимодействие с пользователем.

**Ключевые компоненты**:
- `Header` - шапка сайта с индикацией загрузки и аутентификации
- `EventsPage` - страница мероприятий с пагинацией и сортировкой
- `EventCardSkeleton` и `EventsSkeletonGrid` - компоненты для визуализации состояния загрузки
- `GlobalSpinner` - компонент глобального индикатора загрузки

**Принципы работы**:
- Отображение скелетона при загрузке данных
- Независимая загрузка данных для критически важных компонентов
- Гарантированная загрузка после таймаута и защиты от бесконечных скелетонов
- Обнаружение глобального спиннера в DOM для синхронизации с флагами загрузки
- Принудительное скрытие индикаторов загрузки при завершении запросов
- Специальная обработка админских маршрутов с ускоренным переходом к COMPLETED

## Система логирования

### Общие принципы

**Ключевые компоненты**:
- Уровни логирования (`LOG_LEVEL`): NONE, ERROR, WARN, INFO, DEBUG
- Функции логирования: `logDebug`, `logInfo`, `logWarn`, `logError`
- Динамический выбор уровня логирования в зависимости от окружения (production/development)

**Принципы работы**:
- В продакшене отображаются только WARN и ERROR сообщения
- В разработке по умолчанию отображаются INFO и выше
- Каждый модуль использует префикс с его названием (напр. "API:", "Header:", "LoadingContext:")
- Визуальные индикаторы для ошибок (⛔) и предупреждений (⚠️)
- Фильтрация несущественных логов для уменьшения "шума" в консоли

### Умное логирование

**Принципы работы**:
- Логирование только при изменении состояния, а не при каждом рендере
- Использование useRef для отслеживания предыдущих значений
- Группировка связанных событий для улучшения читаемости
- Фокус на критически важных изменениях стадий и ошибках
- Минимизация "шума" от несущественных событий
- Расширенное логирование для обнаруженных несогласованностей и их исправлений

## Взаимодействие компонентов

1. **Инициализация приложения**:
   - LoadingContext устанавливает начальную стадию AUTHENTICATION
   - AuthContext/AdminAuthContext начинает проверку аутентификации
   - API блокирует все запросы, кроме аутентификационных и публичных запросов к мероприятиям
   - Устанавливается история изменений стадий для предотвращения регрессии

2. **Завершение аутентификации**:
   - AuthContext/AdminAuthContext завершает проверку и обновляет isAuthChecked
   - AuthContext/AdminAuthContext отправляет событие auth-stage-change для перехода к следующей стадии
   - LoadingContext переходит к стадии STATIC_CONTENT
   - API разрешает статические и публичные запросы
   - Система строго блокирует любые попытки вернуться к стадии AUTHENTICATION

3. **Загрузка данных**:
   - Компоненты могут начать загрузку данных с использованием setDynamicLoading
   - Для критических компонентов (например, EventsPage) загрузка данных происходит по таймеру
   - Компоненты могут использовать bypassLoadingStageCheck для критических запросов
   - Система периодически проверяет и исправляет несогласованность флагов загрузки
   - При завершении загрузки данных происходит автоматический переход к стадии DATA_LOADING
   - Если нет активных запросов, система переходит к стадии COMPLETED

4. **Индикация загрузки**:
   - Скелетон-компоненты отображаются во время загрузки
   - Предусмотрены таймеры для скрытия скелетонов через 2 секунды
   - Система отслеживает DOM для обнаружения глобального спиннера
   - Автоматическое исправление "зависших" индикаторов загрузки
   - Принудительный сброс флагов загрузки при несоответствии

## Особые случаи

### Страница мероприятий (EventsPage)

Страница мероприятий имеет особую обработку в системе загрузки:
- **Независимый механизм загрузки**: Страница использует таймеры для гарантированной загрузки данных независимо от стадии
- **Безусловная загрузка данных**: Запрос данных происходит через короткий таймаут (200мс) после монтирования компонента
- **Обход проверки стадии**: Все запросы выполняются с опцией bypassLoadingStageCheck
- **Защита от зависания**: Предусмотрен таймаут в 2 секунды для гарантированного скрытия скелетона
- **Отслеживание загруженных данных**: Используется ref hasInitialData для предотвращения повторных запросов
- **Эффективная индикация загрузки**: Скелетон-компоненты предоставляют визуальный фидбек
- **Предотвращение проблем с замыканиями**: Критические операции используют прямые API-запросы с явными параметрами
- **Борьба с кэшированием**: Добавление параметра _nocache с временной меткой для гарантии свежих данных
- **Очистка кэша по требованию**: Использование clearCache для очистки кэша API при сбросе фильтров
- **Автоматическое исправление несогласованности**: Периодическая проверка на несоответствие флагов загрузки и стадий

### Администраторская панель и авторизация

Администраторская часть имеет специфические особенности взаимодействия с системой загрузки:
- **Ускоренный переход через стадии**: Админские маршруты автоматически быстро переходят к COMPLETED
- **Оптимизация проверки авторизации**: Многоуровневая стратегия с локальной валидацией
- **Автоматическое обновление токенов**: Middleware обновляет токены при приближении к концу срока действия
- **Защита от регрессии стадий**: Дополнительная проверка для предотвращения возврата к AUTHENTICATION
- **Кэширование данных профиля**: Сохранение профиля администратора в localStorage
- **Устойчивость к сетевым проблемам**: Использование локальной валидации при недоступности сервера
- **Отметка маршрутов**: Использование флага is_admin_route в localStorage для специальной обработки
- **Обработка сценариев истечения сессии**: Автоматическая очистка данных при получении 401/403 ответов

### Обработка фильтрации данных

Фильтрация данных в приложении требует особого внимания из-за специфики React:
- **Прямые API-запросы для критических операций**: Сброс фильтров выполняется через прямой запрос к API
- **Предотвращение проблем с замыканиями**: Использование текущих значений при выполнении запросов
- **Явное указание параметров запроса**: Гарантия корректных параметров в URL
- **Полный сброс состояния компонента**: При сбросе фильтров выполняется полное обнуление связанных значений
- **Обработка разных форматов API-ответов**: Универсальная обработка и форматирование ответов
- **Различная обработка в зависимости от UI-контекста**: Разное поведение при сбросе из разных компонентов
- **Подробное логирование операций**: Детальное отслеживание источника запросов и параметров

### Автоматический переход между стадиями

Система включает механизм автоматического перехода между стадиями:
- Таймауты для автоматического перехода к следующей стадии (5 секунд)
- Защита от застревания на одной стадии
- Логирование изменений стадий для отладки
- Строгое блокирование возвратов к предыдущим стадиям
- Отслеживание истории стадий для предотвращения циклов и регрессии
- Проверка наличия активных запросов перед переходом к следующей стадии

### Обнаружение и исправление несогласованности загрузки

Система постоянно отслеживает и исправляет несоответствия между флагами загрузки и стадиями:
- **Периодические проверки**: Каждые 2 секунды выполняется функция `detectAndFixLoadingInconsistency`
- **Проверка активных флагов**: Если флаги загрузки активны на поздних стадиях без активных запросов, они сбрасываются
- **Проверка завершения загрузки**: На ранних стадиях при отсутствии флагов загрузки происходит продвижение к следующей стадии
- **Автоматический переход к COMPLETED**: При завершении всех запросов на стадии DATA_LOADING
- **Отслеживание DOM**: Проверка наличия глобального спиннера для синхронизации с состоянием загрузки
- **Принудительное обновление UI**: Гарантированное скрытие спиннера при завершении всех запросов
- **Таймеры безопасности**: Дополнительные проверки через 500мс и 1с после завершения запросов

## Рекомендации по разработке

1. **Загрузка данных в компонентах**:
   - Для критически важных данных используйте таймеры и bypassLoadingStageCheck
   - Добавляйте защиту от зависания с таймаутами для скрытия состояний загрузки
   - Отслеживайте статус загрузки через useRef для предотвращения повторных запросов
   - Используйте корректный сброс флагов загрузки при завершении запросов
   - Добавляйте обработку ошибок с таймаутами для гарантированного прогресса стадий

2. **Оптимизация запросов**:
   - Используйте кэширование для уменьшения количества запросов
   - Отменяйте ненужные запросы с помощью AbortController
   - Добавляйте защиту от слишком частых запросов
   - Используйте дедупликацию запросов с интервалом 50мс
   - Корректно обновляйте глобальный счетчик активных запросов

3. **Обработка ошибок**:
   - Логируйте ошибки с контекстом для упрощения отладки
   - Предоставляйте пользователю понятные сообщения
   - Не зависайте в состоянии загрузки при ошибках - используйте таймауты
   - Обязательно сбрасывайте флаги загрузки при получении ошибок
   - Обрабатывайте ошибки авторизации с отправкой события auth-unauthorized

4. **Производительность и UX**:
   - Всегда показывайте индикаторы загрузки, но ограничивайте их время отображения
   - Добавляйте защиту от мигания интерфейса при быстрой загрузке
   - Используйте скелетон-компоненты вместо спиннеров для лучшего UX
   - Гарантируйте отображение содержимого через таймауты безопасности
   - Используйте механизм обнаружения и исправления несогласованности

5. **Работа с токенами авторизации**:
   - Применяйте локальную валидацию JWT для снижения нагрузки на сервер
   - Используйте стратегию обновления токенов при приближении к сроку истечения
   - Реализуйте дебаунсинг для проверок состояния авторизации
   - Предусматривайте корректную обработку ошибок сети при проверке авторизации
   - Специально обрабатывайте админские маршруты для ускоренного перехода стадий

6. **Работа с флагами загрузки**:
   - Гарантируйте сброс флагов загрузки при завершении всех запросов
   - Используйте дополнительные таймеры для проверки состояния загрузки
   - Синхронизируйте глобальные флаги с внутренним состоянием компонентов
   - Проверяйте несогласованность между стадиями и флагами загрузки
   - Отслеживайте глобальный спиннер в DOM для точной синхронизации 