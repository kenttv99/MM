# Улучшения в системе загрузки

## Основные модификации

### 1. LoadingContext
- Увеличен RESET_DEBOUNCE до 2 секунд для предотвращения частых сбросов
- Добавлена защита от сброса во время аутентификации
- Реализовано отслеживание истории изменений стадий с лимитом в 10 последних состояний
- Предотвращены повторные вызовы одинаковых стадий и обнаружение циклов
- Строгое блокирование регрессии к стадии AUTHENTICATION после перехода к более высоким стадиям
- Удалена ответственность за отслеживание статуса аутентификации (isAuthChecked)
- Улучшена архитектура с разделением ответственности между контекстами
- Добавлены вспомогательные функции логирования с разными приоритетами
- Внедрена система обнаружения и исправления несогласованности флагов загрузки (проверка каждые 2 секунды)
- Добавлены таймеры для гарантированного сброса флагов динамической загрузки
- Улучшен механизм обнаружения "бесконечного спиннера" с проверкой DOM-элементов
- Внедрена явная синхронизация между глобальными флагами и состоянием компонентов
- Добавлена специальная обработка админских маршрутов с ускоренным переходом к COMPLETED
- Добавлены автоматические таймеры для перехода к следующей стадии через 5 секунд

### 2. API
- Улучшена функция shouldProcessRequest с более детальной проверкой запросов
- Добавлено отслеживание запросов по стадиям загрузки с учетом статистики
- Увеличен приоритет кэша на ранних стадиях загрузки с расширенным TTL
- Улучшена обработка JSON и не-JSON ответов с попыткой распознавания формата
- Оптимизирована опция bypassLoadingStageCheck для критически важных запросов
- Реализована строгая блокировка возврата к стадии AUTHENTICATION для предотвращения циклов
- Увеличено максимальное количество одновременных запросов до 15 (с 12)
- Уменьшен интервал дедупликации запросов до 50мс (со 100мс)
- Уменьшена задержка сброса глобальной блокировки до 50мс (со 100мс)
- Добавлена проверка на циклы изменения стадий с историей и отслеживанием времени
- Разрешены публичные запросы к мероприятиям на всех стадиях загрузки

### 3. AuthContext и AdminAuthContext
- Добавлены таймеры безопасности для предотвращения зависания в стадии аутентификации
- Улучшено логирование для отслеживания процесса
- Добавлены четкие переходы к следующим стадиям через события auth-stage-change
- Синхронизировано поведение между двумя контекстами
- Добавлено локальное состояние isAuthChecked как единственный источник правды о статусе аутентификации
- Улучшена инкапсуляция - контексты теперь сами переключают стадии в LoadingContext при завершении проверки
- Отметка админских маршрутов в localStorage (is_admin_route) для особой обработки
- Ускоренный переход через стадии для админских маршрутов

### 4. Header
- Оптимизировано взаимодействие с AuthContext
- Сокращено время таймаута до 200мс для более быстрого отображения
- Упрощена логика работы Header благодаря единому источнику правды
- Внедрена система уровней логирования с фильтрацией несущественных сообщений
- Умное логирование только при изменении состояний, а не при каждом рендере

### 5. Events Page
- Радикально упрощен механизм загрузки данных с минимальной зависимостью от стадий загрузки
- Добавлены таймеры безусловной загрузки данных через короткое время (200мс) после монтирования
- Реализована защита от бесконечного отображения скелетона с таймаутом 2 секунды
- Использование useRef для отслеживания состояния загрузки и предотвращения дублирования запросов
- Добавлен обход проверки стадии загрузки для всех запросов мероприятий
- Добавлена защита от слишком частых запросов (rate limiting)
- Улучшенная визуализация состояния загрузки с использованием скелетон-лоадеров
- Оптимизированная система логирования с фокусом на критические изменения состояния
- Прямое использование функции clearCache вместо событий для очистки кэша

### 6. AdminAuthContext и управление токенами
- Реализована многоуровневая стратегия проверки авторизации для снижения нагрузки на сервер
- Добавлена локальная валидация JWT-токенов без сетевых запросов
- Внедрён буфер времени для оптимизации запросов (TOKEN_EXPIRY_BUFFER = 300 секунд)
- Реализован дебаунсинг проверок сессии (SESSION_CHECK_DEBOUNCE_MS = 120000 мс)
- Создан middleware на сервере для автоматического обновления токенов администратора
- Добавлена логика обновления токенов при приближении к сроку истечения (< 5 минут)
- Реализована передача обновлённых токенов через заголовок X-Refresh-Token
- Добавлена обработка обновлённых токенов на стороне клиента
- Улучшена устойчивость к сетевым проблемам с использованием локальной валидации
- Добавлено кэширование данных профиля администратора для быстрого восстановления
- Реализована автоматическая очистка данных сессии при получении 401/403 ответов
- Создана защита от частых запросов к серверу с помощью rate limiting
- Добавлена отметка админских маршрутов в localStorage для ускоренной обработки

### 7. Обнаружение и исправление несогласованности загрузки
- Создан механизм обнаружения несогласованности между флагами загрузки и стадиями
- Добавлены периодические проверки каждые 2 секунды для выявления зависших состояний
- Реализовано автоматическое продвижение по стадиям при обнаружении несоответствий
- Улучшена синхронизация между глобальными флагами и внутренним состоянием
- Внедрены проверки "осиротевших" флагов загрузки при отсутствии активных запросов
- Добавлена проверка наличия глобального спиннера в DOM для синхронизации состояния
- Реализованы дополнительные таймеры безопасности для проверки через 500мс и 1с

## Архитектурные изменения

### Разделение ответственности
- **LoadingContext**: Управляет только стадиями загрузки и связанными состояниями
- **AuthContext/AdminAuthContext**: Отвечают за проверку аутентификации и самостоятельно управляют переходами стадий
- **Компоненты**: Могут загружать данные независимо от стадии загрузки для критических случаев
- **API**: Отслеживает стадии загрузки и статистику запросов, предотвращает регрессию стадий

### Независимая загрузка данных
- Критически важные компоненты (как EventsPage) не зависят полностью от стадии загрузки
- Использование таймеров для гарантированной загрузки данных независимо от состояния контекста
- Установка временных ограничений для отображения индикаторов загрузки
- Возможность обхода проверки стадии для обеспечения доступности данных
- Прямое использование clearCache для очистки кэша вместо событий

### Система логирования
- **Уровни приоритета**: ERROR, WARN, INFO, DEBUG, NONE
- **Контроль вывода**: Автоматическое переключение уровня логирования в зависимости от окружения
- **Контекстные префиксы**: Каждый модуль использует свой префикс для упрощения фильтрации логов
- **Умные решения для логирования**: Логирование только при изменении состояний, а не при каждом рендере
- **Фильтрация несущественных сообщений**: Снижение "шума" в консоли разработчика

### Умная проверка авторизации администратора

#### Локальная валидация JWT-токенов
- Декодирование токена и проверка поля exp на клиенте
- Предотвращение ненужных сетевых запросов при валидном токене
- Защита от слишком частых проверок с сервером
- Повышение отзывчивости интерфейса за счёт мгновенной локальной проверки

#### Стратегия обновления токенов
- Отслеживание срока истечения токена на сервере через middleware
- Автоматическое обновление при приближении к концу срока действия
- Поддержка непрерывной сессии администратора
- Минимизация риска внезапного выхода из системы

#### Обработка сетевых ошибок
- Приоритет локальной валидации при недоступности сервера
- Сохранение сессии при временных проблемах с сетью
- Логирование проблем для последующего анализа
- Автоматические повторные попытки после восстановления соединения

### Система обнаружения и исправления несогласованности
- Периодическая проверка соответствия между флагами загрузки и текущими стадиями (каждые 2 секунды)
- Автоматическое продвижение по стадиям при отсутствии активных запросов
- Принудительный сброс флагов загрузки при обнаружении несоответствия
- Расширенное логирование для выявления и отслеживания проблем загрузки
- Улучшенная система обработки завершения запросов с гарантированным обновлением UI
- Отслеживание DOM-элементов для обнаружения спиннера и синхронизации состояния
- Дополнительные таймеры безопасности для проверки через короткие интервалы

### Преимущества новой архитектуры
- Устойчивость к зависаниям и циклам стадий загрузки
- Гарантированная загрузка данных для критических компонентов
- Защита от бесконечного отображения состояний загрузки
- Улучшение UX с ограниченным временем показа скелетонов
- Чистая консоль разработчика с фокусом на важных сообщениях
- Снижение нагрузки на сервер за счёт оптимизации запросов авторизации
- Бесшовное обновление токенов без прерывания работы пользователя
- Повышенная устойчивость к проблемам с сетью
- Автоматическое восстановление при обнаружении несогласованности состояний
- Гарантированное скрытие спиннера загрузки даже при проблемах в async/await операциях
- Явная синхронизация между глобальными флагами загрузки и внутренним состоянием компонентов
- Специальная оптимизированная обработка админских маршрутов
- Увеличенная пропускная способность: Поддержка до 15 одновременных запросов
- Улучшенная дедупликация: Более быстрое обнаружение дублирующихся запросов (50мс)

## Последовательность загрузки страницы

1. **Инициализация**
   - Монтирование компонентов и установка начальной стадии AUTHENTICATION
   - Запуск таймеров безопасности для независимых компонентов
   - Локальная проверка JWT-токенов для быстрой предварительной авторизации
   - Инициализация истории изменений стадий для предотвращения регрессии

2. **Аутентификация**
   - AuthContext/AdminAuthContext проверяют наличие токена и его валидность
   - По завершении проверки контексты отправляют событие auth-stage-change
   - LoadingContext переходит к стадии STATIC_CONTENT при получении события
   - При наличии валидного токена запрос к серверу отправляется только при необходимости
   - Строгая блокировка любых попыток возврата к стадии AUTHENTICATION

3. **Загрузка данных**
   - Критические компоненты начинают загрузку данных через таймер независимо от стадии
   - API принимает запросы с опцией bypassLoadingStageCheck для обхода проверки стадии
   - Скелетон-компоненты отображаются в течение ограниченного времени (2 секунды)
   - Автоматическое обновление токенов администратора в фоновом режиме
   - Периодическая проверка и исправление несогласованности флагов загрузки
   - Обнаружение и синхронизация с глобальным спиннером в DOM

4. **Завершение загрузки**
   - Компоненты скрывают индикаторы загрузки после получения данных или по таймауту
   - Принудительное продвижение к COMPLETED при отсутствии активных запросов
   - Пользователь видит полностью загруженный интерфейс
   - Продолжение фоновой проверки и обновления токенов
   - Гарантированный сброс флагов загрузки даже при проблемах в Promise-цепочках

## Ключевые улучшения для EventsPage

### Устойчивость к проблемам в контексте
- **Независимая загрузка**: Данные загружаются через таймер после инициализации
- **Обход проверки стадии**: Все запросы используют bypassLoadingStageCheck
- **Защита от зацикливания**: Отслеживание состояния загрузки через useRef
- **Гарантированное скрытие скелетона**: Таймер автоматически скрывает скелетон через 2 секунды
- **Прямые API-запросы**: Критические операции (сброс фильтров) используют прямые запросы
- **Предотвращение кэширования**: Добавление параметра _nocache с временной меткой для принудительного обновления данных
- **Прямая очистка кэша**: Использование clearCache вместо событий для большей надежности
- **Автоматическое обнаружение и исправление несогласованности флагов загрузки

### Улучшение UX
- **Мгновенный ответ**: Скелетон отображается сразу при загрузке страницы
- **Предсказуемое поведение**: Гарантированное отображение содержимого через определенное время
- **Отсутствие зависаний**: Защита от бесконечной загрузки и пустых страниц
- **Надежное управление фильтрами**: Корректная работа кнопок сброса фильтров
- **Непрерывная авторизация**: Бесшовное обновление токенов администратора
- **Гарантированное скрытие глобального спиннера**: Проверка DOM и принудительный сброс флагов

### Оптимизация производительности
- **Ограничение частоты запросов**: Защита от слишком частых вызовов API
- **Отмена устаревших запросов**: Использование AbortController для отмены ненужных запросов
- **Кэширование данных**: Сохранение предыдущих результатов для оптимизации отображения
- **Очистка кэша по требованию**: Прямой вызов clearCache при необходимости
- **Оптимизация запросов авторизации**: Снижение нагрузки на сервер с помощью локальной валидации
- **Принудительный сброс всех флагов загрузки**: Гарантированное обновление при отсутствии активных запросов
- **Оптимизированная дедупликация запросов**: Интервал сокращен до 50мс для быстрой реакции

## Система управления фильтрами и состоянием данных

### Проблемы с замыканиями в React и их решение
- **Проблема устаревшего состояния**: Функции в замыканиях используют значения на момент создания, а не на момент вызова
- **Решение для критических операций**: Прямое выполнение API-запросов в обработчиках событий
- **Гарантия актуальных параметров**: Явное указание значений фильтров в URL
- **Изоляция запросов**: Создание отдельных контроллеров для операций сброса фильтров

### Улучшенная обработка API-ответов
- **Универсальное форматирование**: Обработка различных форматов ответа API
- **Подробное логирование**: Логирование исходного ответа и отформатированных данных
- **Обработка пустых ответов**: Корректное преобразование пустых или неожиданных форматов
- **Попытка распознавания JSON**: Автоматическое распознавание и преобразование JSON-строк
- **Улучшенная обработка не-JSON ответов**: Более гибкий анализ текстовых ответов

### Оптимизации фильтрации и загрузки данных
- **Предотвращение кэширования**: Добавление уникальных параметров для сброса кэша
- **Проверка активности фильтров**: Вычисление актуального состояния фильтров
- **Надежный сброс состояния**: Полный сброс состояния компонента при очистке фильтров
- **Поддержка различных UI-сценариев**: Отдельная обработка сброса фильтров из разных контекстов
- **Прямая очистка кэша**: Использование clearCache с паттернами URL

## Механизм обнаружения и исправления несогласованности загрузки

### Проблема и решение
- **Проблема**: Возможная несогласованность между флагами загрузки и текущей стадией
- **Решение**: Периодическая проверка и автоматическое исправление
- **Реализация**: Функция `detectAndFixLoadingInconsistency` с проверкой каждые 2 секунды
- **Принцип работы**: Обнаружение и исправление четырех основных типов несогласованности

### Типы обнаруживаемых несоответствий
- **Активные флаги + высокая стадия**: Флаги загрузки активны, но стадия DATA_LOADING или COMPLETED
- **Неактивные флаги + ранняя стадия**: Флаги загрузки неактивны, но стадия STATIC_CONTENT
- **Завершение динамической загрузки**: Отсутствие активных запросов на стадии DYNAMIC_CONTENT
- **Завершение загрузки данных**: Отсутствие активных запросов на стадии DATA_LOADING
- **Отсутствие DOM-элемента спиннера**: Флаги загрузки активны, но спиннер отсутствует в DOM

### Алгоритм исправления
- Обнаружение несоответствия между флагами и текущей стадией
- Принудительный сброс флагов и/или переход к соответствующей стадии
- Явное обновление глобальных флагов и состояния компонентов
- Логирование для отслеживания проблем и примененных исправлений
- Дополнительные проверки через короткие интервалы для подтверждения исправлений

### Улучшения функции setDynamicLoading
- Более надежная обработка завершения запросов
- Гарантированный сброс флагов при отсутствии активных запросов
- Явное обновление глобального флага lastDynamicLoadingState
- Автоматический переход к стадии COMPLETED при завершении всех запросов
- Дополнительный таймер для финальной проверки состояния через секунду

### Улучшения функции safeSetState
- Сохранение текущего состояния динамической загрузки
- Принудительный сброс всех флагов при завершении загрузки на поздних стадиях
- Синхронизация глобального флага lastDynamicLoadingState с внутренним состоянием
- Автоматический переход к стадии COMPLETED при нахождении на стадии DATA_LOADING

### Улучшения отслеживания глобального спиннера
- Проверка DOM для обнаружения элемента .global-spinner
- Принудительный сброс флагов, если спиннер отсутствует, но флаги активны
- Переход к стадии COMPLETED при обнаружении "осиротевших" флагов загрузки
- Подробное логирование для диагностики редких случаев зависания спиннера
- Увеличен интервал проверки до 1 секунды для снижения нагрузки

## Преимущества нового подхода

- **Надежность**: Устранение проблем с зависанием во время аутентификации и загрузки данных
- **Производительность**: Более эффективная загрузка с минимизацией лишних запросов
- **Отладка**: Улучшенное логирование с фокусом на критические события
- **UX**: Предсказуемое поведение загрузки с гарантированным показом содержимого
- **Инкапсуляция**: Более четкое разделение ответственности между модулями
- **Безопасность**: Строгая защита от зацикливания и регрессии стадий
- **Удобство разработки**: Значительно уменьшен объем вывода в консоль без потери важной информации
- **Оптимизация авторизации**: Снижение нагрузки на сервер с умной проверкой токенов
- **Непрерывность сессии**: Автоматическое фоновое обновление токенов для бесшовного UX
- **Устойчивость**: Повышенная отказоустойчивость при проблемах с сетью
- **Автоматическое исправление**: Самодиагностика и исправление проблем с несогласованностью загрузки
- **Гарантированное скрытие спиннера**: Защита от "зависания" индикаторов загрузки
- **Усовершенствованная синхронизация**: Надежная связь между флагами и состоянием компонентов
- **Оптимизация для админов**: Ускоренный переход через стадии для админских маршрутов
- **Увеличенная пропускная способность**: Поддержка до 15 одновременных запросов
- **Улучшенная дедупликация**: Более быстрое обнаружение дублирующихся запросов (50мс)

