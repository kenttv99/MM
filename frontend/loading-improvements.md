# Улучшения в системе загрузки

## Основные модификации

### 1. LoadingContext
- Увеличен RESET_DEBOUNCE до 2 секунд для предотвращения частых сбросов
- Добавлена защита от сброса во время аутентификации
- Реализовано отслеживание истории изменений стадий
- Предотвращены повторные вызовы одинаковых стадий
- Блокирование регрессии к стадии AUTHENTICATION после перехода к более высоким стадиям
- Удалена ответственность за отслеживание статуса аутентификации (isAuthChecked)
- Улучшена архитектура с разделением ответственности между контекстами
- Добавлены вспомогательные функции логирования с разными приоритетами (debug, info, warn, error)

### 2. API
- Улучшена функция shouldProcessRequest с более детальной проверкой запросов
- Добавлено отслеживание запросов по стадиям
- Увеличен приоритет кэша на ранних стадиях загрузки
- Улучшена обработка JSON и не-JSON ответов
- Добавлена опция bypassLoadingStageCheck для обхода проверки стадии загрузки
- Реализована блокировка возврата к стадии AUTHENTICATION для предотвращения циклов

### 3. AuthContext и AdminAuthContext
- Добавлены таймеры безопасности для предотвращения зависания в стадии аутентификации
- Улучшено логирование для отслеживания процесса
- Добавлены четкие переходы к следующим стадиям после аутентификации
- Синхронизировано поведение между двумя контекстами
- Добавлено локальное состояние isAuthChecked как единственный источник правды о статусе аутентификации
- Улучшена инкапсуляция - AuthContext теперь сам переключает стадии в LoadingContext при завершении проверки

### 4. Header
- Оптимизировано взаимодействие с AuthContext
- Сокращено время таймаута до 200мс для более быстрого отображения
- Упрощена логика работы Header благодаря единому источнику правды
- Внедрена система уровней логирования с фильтрацией несущественных сообщений
- Умное логирование только при изменении состояний, а не при каждом рендере

### 5. Events Page
- Радикально упрощен механизм загрузки данных с минимальной зависимостью от стадий загрузки
- Добавлены таймеры безусловной загрузки данных через короткое время (200мс) после монтирования
- Реализована защита от бесконечного отображения скелетона с таймаутом 2 секунды
- Использование useRef для отслеживания состояния загрузки и предотвращения дублирования запросов
- Добавлен обход проверки стадии загрузки для всех запросов мероприятий
- Добавлена защита от слишком частых запросов (rate limiting)
- Улучшенная визуализация состояния загрузки с использованием скелетон-лоадеров
- Оптимизированная система логирования с фокусом на критические изменения состояния

## Архитектурные изменения

### Разделение ответственности
- **LoadingContext**: Управляет только стадиями загрузки и связанными состояниями
- **AuthContext/AdminAuthContext**: Отвечают за проверку аутентификации и самостоятельно управляют переходами стадий в LoadingContext
- **Компоненты**: Могут загружать данные независимо от стадии загрузки для критически важных случаев

### Независимая загрузка данных
- Критически важные компоненты (как EventsPage) не зависят полностью от стадии загрузки
- Использование таймеров для гарантированной загрузки данных независимо от состояния контекста
- Установка временных ограничений для отображения индикаторов загрузки
- Возможность обхода проверки стадии для обеспечения доступности данных

### Система логирования
- **Уровни приоритета**: ERROR, WARN, INFO, DEBUG, NONE
- **Контроль вывода**: Автоматическое переключение уровня логирования в зависимости от окружения (production/development)
- **Контекстные префиксы**: Каждый модуль использует свой префикс для упрощения фильтрации логов
- **Умные решения для логирования**: Логирование только при изменении состояний, а не при каждом рендере

### Преимущества новой архитектуры
- Устойчивость к зависаниям и циклам стадий загрузки
- Гарантированная загрузка данных для критических компонентов
- Защита от бесконечного отображения состояний загрузки
- Улучшение UX с ограниченным временем показа скелетонов
- Чистая консоль разработчика с фокусом на важных сообщениях

## Последовательность загрузки страницы

1. **Инициализация**
   - Монтирование компонентов и установка начальной стадии AUTHENTICATION
   - Запуск таймеров безопасности для независимых компонентов

2. **Аутентификация**
   - AuthContext проверяет наличие токена
   - По завершении проверки AuthContext сам переключает LoadingContext на STATIC_CONTENT
   - Блокировка любых попыток возврата к стадии AUTHENTICATION

3. **Загрузка данных**
   - Критические компоненты начинают загрузку данных через таймер независимо от стадии
   - API принимает запросы с опцией bypassLoadingStageCheck для обхода проверки стадии
   - Скелетон-компоненты отображаются в течение ограниченного времени

4. **Завершение загрузки**
   - Компоненты скрывают индикаторы загрузки после получения данных или по таймауту
   - Пользователь видит полностью загруженный интерфейс

## Ключевые улучшения для EventsPage

### Устойчивость к проблемам в контексте
- **Независимая загрузка**: Данные загружаются через таймер после инициализации
- **Обход проверки стадии**: Все запросы используют bypassLoadingStageCheck
- **Защита от зацикливания**: Отслеживание состояния загрузки через useRef
- **Гарантированное скрытие скелетона**: Таймер автоматически скрывает скелетон через 2 секунды

### Улучшение UX
- **Мгновенный ответ**: Скелетон отображается сразу при загрузке страницы
- **Предсказуемое поведение**: Гарантированное отображение содержимого через определенное время
- **Отсутствие зависаний**: Защита от бесконечной загрузки и пустых страниц

### Оптимизация производительности
- **Ограничение частоты запросов**: Защита от слишком частых вызовов API
- **Отмена устаревших запросов**: Использование AbortController для отмены ненужных запросов
- **Кэширование данных**: Сохранение предыдущих результатов для оптимизации отображения

## Преимущества нового подхода

- **Надежность**: Устранение проблем с зависанием во время аутентификации и загрузки данных
- **Производительность**: Более эффективная загрузка с минимизацией лишних запросов
- **Отладка**: Улучшенное логирование с фокусом на критические события
- **UX**: Предсказуемое поведение загрузки с гарантированным показом содержимого
- **Инкапсуляция**: Более четкое разделение ответственности между модулями
- **Безопасность**: Адекватная защита от зацикливания и регрессии стадий
- **Удобство разработки**: Значительно уменьшен объем вывода в консоль без потери важной информации

