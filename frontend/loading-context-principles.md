# Базовые принципы и компоненты контекста загрузки

## Архитектура системы загрузки

Система загрузки в приложении построена на основе нескольких ключевых контекстов, которые взаимодействуют между собой для обеспечения плавного пользовательского опыта:

### 1. LoadingContext

**Основная ответственность**: Управление стадиями загрузки и состоянием загрузки в приложении.

**Ключевые компоненты**:
- `LoadingStage` - перечисление стадий загрузки (AUTHENTICATION, STATIC_CONTENT, DYNAMIC_CONTENT, DATA_LOADING, COMPLETED)
- `setStage` - функция для явного перехода между стадиями
- `setStaticLoading` - функция для управления статической загрузкой
- `setDynamicLoading` - функция для управления динамической загрузкой
- `resetLoading` - функция для сброса состояния загрузки
- `logDebug`, `logInfo`, `logWarn`, `logError` - функции для логирования с разными уровнями приоритета

**Принципы работы**:
- Стадии загрузки проходят последовательно
- Автоматический переход к следующей стадии после таймаута
- Защита от частых сбросов состояния (debounce)
- Отслеживание истории изменений стадий для предотвращения регрессии
- Блокирование возврата к стадии AUTHENTICATION после перехода к другим стадиям
- Интеллектуальное логирование с фильтрацией по уровням важности

### 2. AuthContext

**Основная ответственность**: Управление состоянием аутентификации пользователя.

**Ключевые компоненты**:
- `isAuthChecked` - флаг, указывающий, что проверка аутентификации завершена
- `isAuthenticated` - флаг, указывающий, что пользователь аутентифицирован
- `login`, `logout` - функции для управления аутентификацией
- `validateToken` - функция для проверки токена

**Принципы работы**:
- Единственный источник истины для состояния аутентификации
- Автоматическая проверка токена при инициализации
- Самостоятельное уведомление LoadingContext о завершении проверки аутентификации
- Инициирование перехода к стадии STATIC_CONTENT после проверки, независимо от результата

### 3. AdminAuthContext

**Основная ответственность**: Управление состоянием аутентификации администратора.

**Ключевые компоненты**:
- `isAuthChecked` - флаг, указывающий, что проверка аутентификации администратора завершена
- `isAuthenticated` - флаг, указывающий, что администратор аутентифицирован
- `loginAdmin`, `logoutAdmin` - функции для управления аутентификацией администратора
- `validateToken` - функция для проверки токена администратора

**Принципы работы**:
- Аналогичен AuthContext, но для административной части
- Независимая проверка аутентификации от обычного AuthContext
- Самостоятельное управление переходами стадий загрузки

### 4. API и запросы

**Основная ответственность**: Выполнение запросов к API с учетом текущей стадии загрузки.

**Ключевые компоненты**:
- `apiFetch` - функция для выполнения запросов с кэшированием и обработкой ошибок
- `shouldProcessRequest` - функция для проверки, должен ли запрос быть обработан на текущей стадии
- `setCurrentLoadingStage` - функция для обновления текущей стадии загрузки в API
- `bypassLoadingStageCheck` - опция для обхода проверки стадии загрузки при необходимости
- Очередь запросов и механизм дедупликации
- Функции логирования с разными уровнями приоритета

**Принципы работы**:
- Блокировка запросов на ранних стадиях загрузки
- Разрешение только аутентификационных запросов на стадии AUTHENTICATION
- Разрешение статических и публичных запросов на стадии STATIC_CONTENT
- Разрешение всех запросов на стадиях DYNAMIC_CONTENT и выше
- Предотвращение возврата к стадии AUTHENTICATION после перехода к более поздним стадиям
- Возможность обхода проверки стадии загрузки для критически важных запросов
- Умное логирование с фокусом на критические события и ошибки

### 5. Компоненты интерфейса

**Основная ответственность**: Отображение интерфейса и взаимодействие с пользователем.

**Ключевые компоненты**:
- `Header` - шапка сайта с индикацией загрузки и аутентификации
- `EventsPage` - страница мероприятий с пагинацией и сортировкой
- `EventCardSkeleton` и `EventsSkeletonGrid` - компоненты для визуализации состояния загрузки
- Система логирования для каждого компонента с правильным контекстом

**Принципы работы**:
- Отображение скелетона при загрузке данных
- Независимая загрузка данных для критически важных компонентов
- Гарантированная загрузка после таймаута и защиты от бесконечных скелетонов
- Оптимизированное логирование для уменьшения шума в консоли

## Система логирования

### Общие принципы

**Ключевые компоненты**:
- Уровни логирования (`LOG_LEVEL`): NONE, ERROR, WARN, INFO, DEBUG
- Функции логирования: `logDebug`, `logInfo`, `logWarn`, `logError`
- Динамический выбор уровня логирования в зависимости от окружения (production/development)

**Принципы работы**:
- В продакшене отображаются только WARN и ERROR сообщения
- В разработке по умолчанию отображаются INFO и выше
- Каждый модуль использует префикс с его названием (напр. "API:", "Header:", "LoadingContext:")
- Визуальные индикаторы для ошибок (⛔) и предупреждений (⚠️)

### Умное логирование

**Принципы работы**:
- Логирование только при изменении состояния, а не при каждом рендере
- Использование useRef для отслеживания предыдущих значений
- Группировка связанных событий для улучшения читаемости
- Фокус на критически важных изменениях стадий и ошибках
- Минимизация "шума" от несущественных событий

## Взаимодействие компонентов

1. **Инициализация приложения**:
   - LoadingContext устанавливает начальную стадию AUTHENTICATION
   - AuthContext начинает проверку аутентификации
   - API блокирует все запросы, кроме аутентификационных

2. **Завершение аутентификации**:
   - AuthContext завершает проверку и обновляет isAuthChecked
   - AuthContext переводит LoadingContext в стадию STATIC_CONTENT
   - API разрешает статические и публичные запросы
   - Система блокирует любые попытки вернуться к стадии AUTHENTICATION

3. **Загрузка данных**:
   - Компоненты могут начать загрузку данных сразу после перехода к STATIC_CONTENT
   - Для критических компонентов (например, EventsPage) загрузка данных происходит по таймеру
   - Компоненты могут использовать bypassLoadingStageCheck для критически важных запросов

4. **Индикация загрузки**:
   - Скелетон-компоненты отображаются во время загрузки
   - Предусмотрены таймеры для скрытия скелетонов, даже если данные не успевают загрузиться
   - Система уведомляет пользователя о статусе через визуальные элементы

## Особые случаи

### Страница мероприятий (EventsPage)

Страница мероприятий имеет особую обработку в системе загрузки:
- **Независимый механизм загрузки**: Страница использует таймеры для гарантированной загрузки данных независимо от стадии
- **Безусловная загрузка данных**: Запрос данных происходит через короткий таймаут (200мс) после монтирования компонента
- **Обход проверки стадии**: Все запросы выполняются с опцией bypassLoadingStageCheck
- **Защита от зависания**: Предусмотрен таймаут в 2 секунды для гарантированного скрытия скелетона
- **Отслеживание загруженных данных**: Используется ref hasInitialData для предотвращения повторных запросов
- **Эффективная индикация загрузки**: Скелетон-компоненты предоставляют визуальный фидбек, даже если данные загружаются дольше обычного

### Автоматический переход между стадиями

Система включает механизм автоматического перехода между стадиями:
- Таймауты для автоматического перехода к следующей стадии
- Защита от застревания на одной стадии
- Логирование изменений стадий для отладки
- Блокирование возвратов к предыдущим стадиям

## Рекомендации по разработке

1. **Загрузка данных в компонентах**:
   - Для критически важных данных используйте таймеры и bypassLoadingStageCheck
   - Добавляйте защиту от зависания в виде таймаутов для скрытия состояний загрузки
   - Отслеживайте статус загрузки через useRef для предотвращения повторных запросов
   - Не полагайтесь только на текущую стадию загрузки для инициации запросов данных

2. **Оптимизация запросов**:
   - Используйте кэширование для уменьшения количества запросов
   - Отменяйте ненужные запросы при размонтировании компонентов
   - Добавляйте защиту от слишком частых запросов (rate limiting)
   - Предусматривайте инициализацию запросов после короткой задержки

3. **Обработка ошибок**:
   - Логируйте ошибки с контекстом для упрощения отладки
   - Предоставляйте пользователю понятные сообщения
   - Не зависайте в состоянии загрузки при ошибках - используйте таймауты

4. **Производительность и UX**:
   - Всегда показывайте индикаторы загрузки, но ограничивайте их время отображения
   - Добавляйте защиту от мигания интерфейса при быстрой загрузке
   - Используйте скелетон-компоненты вместо спиннеров для лучшего UX
   - Гарантируйте отображение содержимого через таймауты безопасности 