# Улучшения в системе загрузки

## Основные модификации

### 1. LoadingContext
- Увеличен RESET_DEBOUNCE до 2 секунд для предотвращения частых сбросов
- Добавлена защита от сброса во время аутентификации
- Реализовано отслеживание истории изменений стадий
- Предотвращены повторные вызовы одинаковых стадий
- Блокирование регрессии к стадии AUTHENTICATION после перехода к более высоким стадиям
- Удалена ответственность за отслеживание статуса аутентификации (isAuthChecked)
- Улучшена архитектура с разделением ответственности между контекстами
- Добавлены вспомогательные функции логирования с разными приоритетами (debug, info, warn, error)
- **Новое**: Внедрена система обнаружения и исправления несогласованности флагов загрузки
- **Новое**: Добавлены таймеры для гарантированного сброса флагов динамической загрузки
- **Новое**: Улучшен механизм обнаружения "бесконечного спиннера" с автоматическим исправлением
- **Новое**: Внедрена явная синхронизация между глобальными флагами и состоянием компонентов

### 2. API
- Улучшена функция shouldProcessRequest с более детальной проверкой запросов
- Добавлено отслеживание запросов по стадиям
- Увеличен приоритет кэша на ранних стадиях загрузки
- Улучшена обработка JSON и не-JSON ответов
- Добавлена опция bypassLoadingStageCheck для обхода проверки стадии загрузки
- Реализована блокировка возврата к стадии AUTHENTICATION для предотвращения циклов

### 3. AuthContext и AdminAuthContext
- Добавлены таймеры безопасности для предотвращения зависания в стадии аутентификации
- Улучшено логирование для отслеживания процесса
- Добавлены четкие переходы к следующим стадиям после аутентификации
- Синхронизировано поведение между двумя контекстами
- Добавлено локальное состояние isAuthChecked как единственный источник правды о статусе аутентификации
- Улучшена инкапсуляция - AuthContext теперь сам переключает стадии в LoadingContext при завершении проверки

### 4. Header
- Оптимизировано взаимодействие с AuthContext
- Сокращено время таймаута до 200мс для более быстрого отображения
- Упрощена логика работы Header благодаря единому источнику правды
- Внедрена система уровней логирования с фильтрацией несущественных сообщений
- Умное логирование только при изменении состояний, а не при каждом рендере

### 5. Events Page
- Радикально упрощен механизм загрузки данных с минимальной зависимостью от стадий загрузки
- Добавлены таймеры безусловной загрузки данных через короткое время (200мс) после монтирования
- Реализована защита от бесконечного отображения скелетона с таймаутом 2 секунды
- Использование useRef для отслеживания состояния загрузки и предотвращения дублирования запросов
- Добавлен обход проверки стадии загрузки для всех запросов мероприятий
- Добавлена защита от слишком частых запросов (rate limiting)
- Улучшенная визуализация состояния загрузки с использованием скелетон-лоадеров
- Оптимизированная система логирования с фокусом на критические изменения состояния

### 6. AdminAuthContext и управление токенами
- Реализована многоуровневая стратегия проверки авторизации для снижения нагрузки на сервер
- Добавлена локальная валидация JWT-токенов без сетевых запросов
- Внедрён буфер времени для оптимизации запросов (TOKEN_EXPIRY_BUFFER = 300 секунд)
- Реализован дебаунсинг проверок сессии (SESSION_CHECK_DEBOUNCE_MS = 120000 мс)
- Создан middleware на сервере для автоматического обновления токенов администратора
- Добавлена логика обновления токенов при приближении к сроку истечения (< 5 минут)
- Реализована передача обновлённых токенов через заголовок X-Refresh-Token
- Добавлена обработка обновлённых токенов на стороне клиента
- Улучшена устойчивость к сетевым проблемам с использованием локальной валидации
- Добавлено кэширование данных профиля администратора для быстрого восстановления
- Реализована автоматическая очистка данных сессии при получении 401/403 ответов
- Создана защита от частых запросов к серверу с помощью rate limiting

### 7. Обнаружение и исправление несогласованности загрузки
- **Новое**: Создан механизм обнаружения несогласованности между флагами загрузки и стадиями
- **Новое**: Добавлены периодические проверки каждые 2 секунды для выявления зависших состояний
- **Новое**: Реализовано автоматическое продвижение по стадиям при обнаружении несоответствий
- **Новое**: Улучшена синхронизация между глобальными флагами и внутренним состоянием
- **Новое**: Внедрены проверки "осиротевших" флагов загрузки при отсутствии активных запросов

## Архитектурные изменения

### Разделение ответственности
- **LoadingContext**: Управляет только стадиями загрузки и связанными состояниями
- **AuthContext/AdminAuthContext**: Отвечают за проверку аутентификации и самостоятельно управляют переходами стадий в LoadingContext
- **Компоненты**: Могут загружать данные независимо от стадии загрузки для критически важных случаев

### Независимая загрузка данных
- Критически важные компоненты (как EventsPage) не зависят полностью от стадии загрузки
- Использование таймеров для гарантированной загрузки данных независимо от состояния контекста
- Установка временных ограничений для отображения индикаторов загрузки
- Возможность обхода проверки стадии для обеспечения доступности данных

### Система логирования
- **Уровни приоритета**: ERROR, WARN, INFO, DEBUG, NONE
- **Контроль вывода**: Автоматическое переключение уровня логирования в зависимости от окружения (production/development)
- **Контекстные префиксы**: Каждый модуль использует свой префикс для упрощения фильтрации логов
- **Умные решения для логирования**: Логирование только при изменении состояний, а не при каждом рендере

### Умная проверка авторизации администратора

#### Локальная валидация JWT-токенов
- Декодирование токена и проверка поля exp на клиенте
- Предотвращение ненужных сетевых запросов при валидном токене
- Защита от слишком частых проверок с сервером
- Повышение отзывчивости интерфейса за счёт мгновенной локальной проверки

#### Стратегия обновления токенов
- Отслеживание срока истечения токена на сервере через middleware
- Автоматическое обновление при приближении к концу срока действия
- Поддержка непрерывной сессии администратора
- Минимизация риска внезапного выхода из системы

#### Обработка сетевых ошибок
- Приоритет локальной валидации при недоступности сервера
- Сохранение сессии при временных проблемах с сетью
- Логирование проблем для последующего анализа
- Автоматические повторные попытки после восстановления соединения

### Система обнаружения и исправления несогласованности
- **Новое**: Периодическая проверка соответствия между флагами загрузки и текущими стадиями
- **Новое**: Автоматическое продвижение по стадиям при отсутствии активных запросов
- **Новое**: Принудительный сброс флагов загрузки при обнаружении несоответствия
- **Новое**: Расширенное логирование для выявления и отслеживания проблем загрузки
- **Новое**: Улучшенная система обработки завершения запросов с гарантированным обновлением UI

### Преимущества новой архитектуры
- Устойчивость к зависаниям и циклам стадий загрузки
- Гарантированная загрузка данных для критических компонентов
- Защита от бесконечного отображения состояний загрузки
- Улучшение UX с ограниченным временем показа скелетонов
- Чистая консоль разработчика с фокусом на важных сообщениях
- Снижение нагрузки на сервер за счёт оптимизации запросов авторизации
- Бесшовное обновление токенов без прерывания работы пользователя
- Повышенная устойчивость к проблемам с сетью
- **Новое**: Автоматическое восстановление при обнаружении несогласованности состояний
- **Новое**: Гарантированное скрытие спиннера загрузки даже при проблемах в async/await операциях
- **Новое**: Явная синхронизация между глобальными флагами загрузки и внутренним состоянием компонентов

## Последовательность загрузки страницы

1. **Инициализация**
   - Монтирование компонентов и установка начальной стадии AUTHENTICATION
   - Запуск таймеров безопасности для независимых компонентов
   - Локальная проверка JWT-токенов для быстрой предварительной авторизации

2. **Аутентификация**
   - AuthContext/AdminAuthContext проверяют наличие токена и его валидность
   - По завершении проверки контексты сами переключают LoadingContext на STATIC_CONTENT
   - При наличии валидного токена запрос к серверу отправляется только при необходимости
   - Блокировка любых попыток возврата к стадии AUTHENTICATION

3. **Загрузка данных**
   - Критические компоненты начинают загрузку данных через таймер независимо от стадии
   - API принимает запросы с опцией bypassLoadingStageCheck для обхода проверки стадии
   - Скелетон-компоненты отображаются в течение ограниченного времени
   - Автоматическое обновление токенов администратора в фоновом режиме
   - **Новое**: Периодическая проверка и исправление несогласованности флагов загрузки

4. **Завершение загрузки**
   - Компоненты скрывают индикаторы загрузки после получения данных или по таймауту
   - Пользователь видит полностью загруженный интерфейс
   - Продолжение фоновой проверки и обновления токенов
   - **Новое**: Гарантированный сброс флагов загрузки даже при проблемах в Promise-цепочках

## Ключевые улучшения для EventsPage

### Устойчивость к проблемам в контексте
- **Независимая загрузка**: Данные загружаются через таймер после инициализации
- **Обход проверки стадии**: Все запросы используют bypassLoadingStageCheck
- **Защита от зацикливания**: Отслеживание состояния загрузки через useRef
- **Гарантированное скрытие скелетона**: Таймер автоматически скрывает скелетон через 2 секунды
- **Прямые API-запросы**: Критические операции (сброс фильтров) используют прямые запросы вместо косвенного вызова fetchEvents
- **Предотвращение кэширования**: Добавление параметра _nocache с временной меткой для принудительного обновления данных
- **Новое**: Автоматическое обнаружение и исправление несогласованности флагов загрузки

### Улучшение UX
- **Мгновенный ответ**: Скелетон отображается сразу при загрузке страницы
- **Предсказуемое поведение**: Гарантированное отображение содержимого через определенное время
- **Отсутствие зависаний**: Защита от бесконечной загрузки и пустых страниц
- **Надежное управление фильтрами**: Корректная работа кнопок сброса фильтров как в модальном окне, так и в заглушке
- **Непрерывная авторизация**: Бесшовное обновление токенов администратора для непрерывной работы
- **Новое**: Гарантированное скрытие глобального спиннера при завершении всех запросов

### Оптимизация производительности
- **Ограничение частоты запросов**: Защита от слишком частых вызовов API
- **Отмена устаревших запросов**: Использование AbortController для отмены ненужных запросов
- **Кэширование данных**: Сохранение предыдущих результатов для оптимизации отображения
- **Очистка кэша по требованию**: Использование событий для очистки кэша API при необходимости (clear-api-cache)
- **Оптимизация запросов авторизации**: Снижение нагрузки на сервер с помощью локальной валидации и дебаунсинга
- **Новое**: Принудительный сброс всех флагов загрузки при отсутствии активных запросов

## Система управления фильтрами и состоянием данных

### Проблемы с замыканиями в React и их решение
- **Проблема устаревшего состояния**: Функции в замыканиях используют значения на момент создания, а не на момент вызова
- **Решение для критических операций**: Прямое выполнение API-запросов в обработчиках событий
- **Гарантия актуальных параметров**: Явное указание пустых значений фильтров в URL для обхода проблем с замыканиями
- **Изоляция запросов**: Создание отдельных контроллеров для операций сброса фильтров

### Улучшенная обработка API-ответов
- **Универсальное форматирование**: Обработка различных форматов ответа API (массивы, объекты с data, items, events, results)
- **Подробное логирование**: Логирование исходного ответа и отформатированных данных для упрощения отладки
- **Обработка пустых ответов**: Корректное преобразование пустых или неожиданных форматов ответа
- **Типизация ответов**: Улучшенная типизация с поддержкой различных форматов данных

### Оптимизации фильтрации и загрузки данных
- **Предотвращение кэширования**: Добавление уникальных параметров для сброса кэша браузера и API
- **Проверка активности фильтров**: Вычисление актуального состояния фильтров в момент выполнения операций
- **Надежный сброс состояния**: Полный сброс состояния компонента при очистке фильтров
- **Поддержка различных UI-сценариев**: Отдельная обработка сброса фильтров из заглушки и модального окна

## Механизм обнаружения и исправления несогласованности загрузки

### Проблема и решение
- **Проблема**: Возможная несогласованность между флагами загрузки и текущей стадией
- **Решение**: Периодическая проверка и автоматическое исправление
- **Реализация**: Функция `detectAndFixLoadingInconsistency` с проверкой каждые 2 секунды
- **Принцип работы**: Обнаружение и исправление четырех основных типов несогласованности

### Типы обнаруживаемых несоответствий
- **Активные флаги + высокая стадия**: Флаги загрузки активны, но стадия DATA_LOADING или COMPLETED
- **Неактивные флаги + ранняя стадия**: Флаги загрузки неактивны, но стадия STATIC_CONTENT
- **Завершение динамической загрузки**: Отсутствие активных запросов на стадии DYNAMIC_CONTENT
- **Завершение загрузки данных**: Отсутствие активных запросов на стадии DATA_LOADING

### Алгоритм исправления
- Обнаружение несоответствия между флагами и текущей стадией
- Принудительный сброс флагов и/или переход к соответствующей стадии
- Явное обновление глобальных флагов и состояния компонентов
- Логирование для отслеживания проблем и примененных исправлений

### Улучшения функции setDynamicLoading
- Более надежная обработка завершения запросов
- Гарантированный сброс флагов при отсутствии активных запросов
- Явное обновление глобального флага lastDynamicLoadingState
- Автоматический переход к стадии COMPLETED при завершении всех запросов
- Таймер для финальной проверки состояния через секунду после завершения

### Улучшения функции safeSetState
- Сохранение текущего состояния динамической загрузки
- Принудительный сброс всех флагов при завершении загрузки на поздних стадиях
- Синхронизация глобального флага lastDynamicLoadingState с внутренним состоянием
- Автоматический переход к стадии COMPLETED при нахождении на стадии DATA_LOADING

### Улучшения отслеживания глобального спиннера
- Проверка несоответствия между наличием спиннера и флагами загрузки
- Принудительный сброс флагов, если спиннер отсутствует, но флаги активны
- Переход к стадии COMPLETED при обнаружении "осиротевших" флагов загрузки
- Подробное логирование для диагностики редких случаев зависания спиннера

## Преимущества нового подхода

- **Надежность**: Устранение проблем с зависанием во время аутентификации и загрузки данных
- **Производительность**: Более эффективная загрузка с минимизацией лишних запросов
- **Отладка**: Улучшенное логирование с фокусом на критические события
- **UX**: Предсказуемое поведение загрузки с гарантированным показом содержимого
- **Инкапсуляция**: Более четкое разделение ответственности между модулями
- **Безопасность**: Адекватная защита от зацикливания и регрессии стадий
- **Удобство разработки**: Значительно уменьшен объем вывода в консоль без потери важной информации
- **Оптимизация авторизации**: Снижение нагрузки на сервер с умной проверкой токенов
- **Непрерывность сессии**: Автоматическое фоновое обновление токенов для бесшовного UX
- **Устойчивость**: Повышенная отказоустойчивость при проблемах с сетью
- **Новое**: Автоматическое исправление проблем с несогласованностью загрузки
- **Новое**: Гарантированное скрытие спиннера даже в сложных случаях асинхронных операций
- **Новое**: Усовершенствованная синхронизация между глобальными флагами и состоянием компонентов

